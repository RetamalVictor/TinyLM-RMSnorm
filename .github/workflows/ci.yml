name: CUDA Kernel Showcase CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    name: Validate Project Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Validate Python syntax
        run: |
          echo "Checking Python syntax..."
          python -m py_compile model.py
          python -m py_compile train.py
          python -m py_compile infer.py
          python -m py_compile scripts/bench_rmsnorm.py
          python -m py_compile scripts/bench_kv_curve.py
          echo "✓ All Python files have valid syntax"

      - name: Verify CUDA kernel implementation
        run: |
          echo "=== CUDA Kernel Showcase Structure ==="
          echo ""
          echo "Core Implementation:"
          test -f model.py && echo "  ✓ model.py - TinyLM transformer with RMSNorm"
          test -f train.py && echo "  ✓ train.py - Training pipeline"
          test -f infer.py && echo "  ✓ infer.py - Inference with KV-cache"
          echo ""
          echo "Custom CUDA Kernel:"
          test -f kernels/rmsnorm_cuda.cu && echo "  ✓ rmsnorm_cuda.cu - Fused CUDA kernel"
          test -f kernels/rmsnorm_binding.cpp && echo "  ✓ rmsnorm_binding.cpp - PyBind11 bindings"
          test -f setup_cuda.py && echo "  ✓ setup_cuda.py - Build configuration"
          echo ""
          echo "Performance Benchmarks:"
          test -f scripts/bench_rmsnorm.py && echo "  ✓ RMSNorm kernel vs PyTorch baseline"
          test -f scripts/bench_kv_vs_nokv.py && echo "  ✓ KV-cache vs no-cache comparison"
          test -f scripts/bench_kv_curve.py && echo "  ✓ Context length scaling"
          echo ""
          echo "Documentation:"
          test -f README.md && echo "  ✓ README.md - Performance claims & setup"
          test -f LICENSE && echo "  ✓ LICENSE - MIT"
          test -f Dockerfile && echo "  ✓ Dockerfile - Deployment ready"
          echo ""
          echo "Note: This project showcases CUDA kernel development expertise"
          echo "Build & test locally with: python setup_cuda.py build_ext --inplace"

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

